# Grafana Datasource Provisioning for Prometheus
# This file automatically configures Prometheus as a datasource in Grafana on startup

apiVersion: 1

# List of datasources to provision
datasources:
  # Main Prometheus datasource for Taskin metrics
  - name: Prometheus
    type: prometheus
    access: proxy
    # URL will be set via environment variable or use default
    url: ${PROMETHEUS_URL:-http://prometheus:9090}
    isDefault: true
    editable: true
    jsonData:
      # Time interval for querying
      timeInterval: 15s
      # Query timeout
      queryTimeout: 60s
      # HTTP method for queries (POST is recommended for large queries)
      httpMethod: POST
      # Enable exemplars (requires Prometheus 2.26+) for trace correlation
      exemplarTraceIdDestinations:
        - name: trace_id
          datasourceUid: tempo
        - name: traceID
          datasourceUid: tempo
      # Data links for correlation between metrics, logs, and traces
      dataLinks:
        - title: 'View logs in Loki'
          url: 'http://localhost:3000/explore?left=["now-1h","now","loki",{"expr":"{service_name=\"taskin-api\"}"}]'
          targetBlank: true
        - title: 'View traces in Tempo'
          url: 'http://localhost:3000/explore?left=["now-1h","now","tempo",{"query":"$${__value.expr}"}]'
          targetBlank: true
        - title: 'View logs in Seq'
          url: '${SEQ_URL:-http://localhost:5341}/#/events?filter=@Timestamp>=${__from:date:iso}&@Timestamp<=${__to:date:iso}'
          targetBlank: true
        - title: 'View in Prometheus'
          url: '${PROMETHEUS_URL:-http://localhost:9090}/graph?g0.expr=${__value.expr}&g0.tab=0&g0.range_input=${__range_s}s'
          targetBlank: true
      # Custom query parameters
      customQueryParameters: ''
      # Prometheus type and version
      prometheusType: Prometheus
      prometheusVersion: 2.45.0
      # Cache level
      cacheLevel: High
      # Disable metrics lookup (improves performance)
      disableMetricsLookup: false
      # Incremental query (performance improvement)
      incrementalQuerying: true
      # Interval factor
      intervalFactor: 2
    # Secure JSON data (passwords, tokens, etc.)
    # secureJsonData:
    #   httpHeaderValue1: 'Bearer YOUR_TOKEN_HERE'
    version: 1
    uid: prometheus

  # Prometheus datasource for alerting (separate for clarity)
  - name: Prometheus-Alerts
    type: prometheus
    access: proxy
    url: ${PROMETHEUS_URL:-http://prometheus:9090}
    isDefault: false
    editable: true
    jsonData:
      timeInterval: 30s
      queryTimeout: 30s
      httpMethod: POST
      manageAlerts: true
      prometheusType: Prometheus
      prometheusVersion: 2.45.0
    version: 1
    uid: prometheus-alerts

# Delete datasources that are not defined here
deleteDatasources:
  - name: Prometheus-Old
    orgId: 1
