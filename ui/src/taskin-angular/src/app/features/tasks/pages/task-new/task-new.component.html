<!-- Loading State -->
@if (loading()) {
  <div class="task-form-container">
    <div class="flex items-center justify-center py-12">
      <mat-progress-bar mode="indeterminate" class="w-64"></mat-progress-bar>
    </div>
  </div>
} @else {
  <!-- Form Container -->
  <div class="task-form-container">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">
        {{ pageTitle() }}
      </h1>
      <p class="text-gray-600">
        @if (isEditMode()) {
          Update the task information below to modify the existing task.
        } @else {
          Fill in the information below to create a new task for your project.
        }
      </p>
    </div>

    <!-- Form -->
    <form [formGroup]="form" (ngSubmit)="onSubmit()" novalidate>
      <!-- Basic Information Section -->
      <mat-card class="form-section">
        <mat-card-header>
          <mat-card-title>Basic Information</mat-card-title>
          <mat-card-subtitle>Essential details about the task</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <!-- Title -->
          <div class="form-row">
            <mat-form-field class="full-width" appearance="outline">
              <mat-label>Task Title *</mat-label>
              <input matInput 
                     formControlName="title" 
                     placeholder="Enter a clear, descriptive title"
                     maxlength="200">
              <mat-hint>{{ form.get('title')?.value?.length || 0 }}/200</mat-hint>
              @if (getFieldError('title')) {
                <mat-error>{{ getFieldError('title') }}</mat-error>
              }
            </mat-form-field>
          </div>

          <!-- Description -->
          <div class="form-row">
            <mat-form-field class="full-width" appearance="outline">
              <mat-label>Description</mat-label>
              <textarea matInput 
                        formControlName="description" 
                        placeholder="Provide a detailed description of what needs to be done"
                        rows="4"
                        maxlength="1000"></textarea>
              <mat-hint>{{ form.get('description')?.value?.length || 0 }}/1000</mat-hint>
              @if (getFieldError('description')) {
                <mat-error>{{ getFieldError('description') }}</mat-error>
              }
            </mat-form-field>
          </div>

          <!-- Project and Status Row -->
          <div class="form-row two-columns">
            <!-- Project -->
            <mat-form-field appearance="outline">
              <mat-label>Project *</mat-label>
              <mat-select formControlName="projectId" placeholder="Select a project">
                @for (project of projects; track project.id) {
                  <mat-option [value]="project.id">{{ project.name }}</mat-option>
                }
              </mat-select>
              @if (getFieldError('projectId')) {
                <mat-error>{{ getFieldError('projectId') }}</mat-error>
              }
            </mat-form-field>

            <!-- Status -->
            <mat-form-field appearance="outline">
              <mat-label>Status *</mat-label>
              <mat-select formControlName="status" placeholder="Select status">
                @for (status of statusOptions; track status.value) {
                  <mat-option [value]="status.value">{{ status.label }}</mat-option>
                }
              </mat-select>
              @if (getFieldError('status')) {
                <mat-error>{{ getFieldError('status') }}</mat-error>
              }
            </mat-form-field>
          </div>

          <!-- Priority and Assignee Row -->
          <div class="form-row two-columns">
            <!-- Priority -->
            <mat-form-field appearance="outline">
              <mat-label>Priority *</mat-label>
              <mat-select formControlName="priority" placeholder="Select priority">
                @for (priority of priorityOptions; track priority.value) {
                  <mat-option [value]="priority.value">
                    <span [class]="priority.color">{{ priority.label }}</span>
                  </mat-option>
                }
              </mat-select>
              @if (getFieldError('priority')) {
                <mat-error>{{ getFieldError('priority') }}</mat-error>
              }
            </mat-form-field>

            <!-- Assignee -->
            <mat-form-field appearance="outline">
              <mat-label>Assignee</mat-label>
              <mat-select formControlName="assigneeId" placeholder="Select assignee">
                <mat-option value="">Unassigned</mat-option>
                @for (assignee of assignees; track assignee.id) {
                  <mat-option [value]="assignee.id">{{ assignee.name }}</mat-option>
                }
              </mat-select>
              @if (getFieldError('assigneeId')) {
                <mat-error>{{ getFieldError('assigneeId') }}</mat-error>
              }
            </mat-form-field>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Schedule and Planning Section -->
      <mat-card class="form-section">
        <mat-card-header>
          <mat-card-title>Schedule & Planning</mat-card-title>
          <mat-card-subtitle>Timeline and effort estimation</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="form-row two-columns">
            <!-- Due Date -->
            <mat-form-field appearance="outline">
              <mat-label>Due Date</mat-label>
              <input matInput 
                     [matDatepicker]="dueDatePicker" 
                     formControlName="dueDate"
                     placeholder="Select due date">
              <mat-datepicker-toggle matSuffix [for]="dueDatePicker"></mat-datepicker-toggle>
              <mat-datepicker #dueDatePicker></mat-datepicker>
              @if (getFieldError('dueDate')) {
                <mat-error>{{ getFieldError('dueDate') }}</mat-error>
              }
            </mat-form-field>

            <!-- Estimated Pomodoros -->
            <mat-form-field appearance="outline">
              <mat-label>Estimated Pomodoros</mat-label>
              <input matInput 
                     type="number" 
                     formControlName="estimatedPomodoros" 
                     placeholder="How many 25-minute sessions?"
                     min="1" 
                     max="50">
              <mat-hint>Each pomodoro = 25 minutes of focused work</mat-hint>
              @if (getFieldError('estimatedPomodoros')) {
                <mat-error>{{ getFieldError('estimatedPomodoros') }}</mat-error>
              }
            </mat-form-field>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Tags Section -->
      <mat-card class="form-section">
        <mat-card-header>
          <mat-card-title>Tags</mat-card-title>
          <mat-card-subtitle>Add tags to categorize and organize your task</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <!-- Tags Input -->
          <mat-form-field class="full-width" appearance="outline">
            <mat-label>Add Tags</mat-label>
            <mat-chip-grid #chipGrid aria-label="Task tags">
              @for (tag of tags(); track tag) {
                <mat-chip-row (removed)="removeTag(tag)">
                  {{ tag }}
                  <button matChipRemove [attr.aria-label]="'Remove ' + tag">
                    <mat-icon>cancel</mat-icon>
                  </button>
                </mat-chip-row>
              }
            </mat-chip-grid>
            <input placeholder="Enter tag and press Enter..."
                   [matChipInputFor]="chipGrid"
                   [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                   (matChipInputTokenEnd)="addTag($event)" />
            <mat-hint>Press Enter or comma to add a tag</mat-hint>
          </mat-form-field>

          <!-- Current Tags Display -->
          @if (tags().length > 0) {
            <div class="mt-4">
              <p class="text-sm font-medium text-gray-700 mb-2">Current tags:</p>
              <div class="chip-list">
                @for (tag of tags(); track tag) {
                  <mat-chip>{{ tag }}</mat-chip>
                }
              </div>
            </div>
          }
        </mat-card-content>
      </mat-card>

      <!-- Form Actions -->
      <div class="form-actions">
        <div class="actions-left">
          <button type="button" 
                  mat-stroked-button 
                  (click)="onReset()"
                  [disabled]="saving()">
            <mat-icon class="mr-2">refresh</mat-icon>
            Reset
          </button>
        </div>

        <div class="actions-right">
          <button type="button" 
                  mat-stroked-button 
                  (click)="onCancel()"
                  [disabled]="saving()">
            Cancel
          </button>
          
          <button type="submit" 
                  mat-raised-button 
                  color="primary"
                  [disabled]="form.invalid || saving()">
            @if (saving()) {
              <mat-progress-spinner diameter="20" class="mr-2"></mat-progress-spinner>
            } @else {
              <mat-icon class="mr-2">
                {{ isEditMode() ? 'save' : 'add' }}
              </mat-icon>
            }
            {{ submitButtonText() }}
          </button>
        </div>
      </div>
    </form>

    <!-- Form Debug (only in development) -->
    <!-- @if (isDevelopment) {
      <mat-card class="mt-8">
        <mat-card-header>
          <mat-card-title>Form Debug</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <pre class="text-xs">{{ form.value | json }}</pre>
          <p class="mt-2 text-sm">Form Valid: {{ form.valid }}</p>
          <p class="text-sm">Form Touched: {{ form.touched }}</p>
        </mat-card-content>
      </mat-card>
    } -->
  </div>
}
